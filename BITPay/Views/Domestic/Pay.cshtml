
@{
    ViewData["Title"] = "Domestic";
}

<h2 class="header-title">Make Domestic Tax Payment</h2>
<div id="mywizard">
    <h3>Search File</h3>
    <section data-mode="async" data-url="@Url.Action("SearchFile")"></section>
    <h3>Make Payment</h3>
    <section>
        <div id="paymentContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
    <h3>Confirm</h3>
    <section>
        <div id="confirmContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
    <h3>Finish</h3>
    <section>
        <div id="finishContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
</div>

@section css{
    <link href="~/lib/jquery.steps/demo/css/jquery.steps.css" rel="stylesheet" />
}

@section Scripts{
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="~/lib/jquery.steps/build/jquery.steps.min.js"></script>

    <script>

        var settings = {
            headerTag: "h3",
            bodyTag: "section",
            transitionEffect: "slideLeft",
            transitionEffectSpeed: 400,
            /* Events */
            onContentLoaded: function (event, currentIndex) {
                if (currentIndex == 0) {
                    $("#searchForm").validate();

                    loadDomesticTax();
                    listenDomesticTaxChange();
                    listenDomesticTaxType();
                    resetValidation();
                }
            },
            onStepChanging: function (event, currentIndex, newIndex) {
                return changingStep(event, currentIndex, newIndex);
            },
            onStepChanged: function (event, currentIndex, priorIndex) {
                stepChanged(event, currentIndex, priorIndex);
            },
            onFinishing: function (event, currentIndex) {
                return true;
            },
            onFinished: function (event, currentIndex) {
                location.reload();
            },
            labels: {
                finish: "Finish <i class='fa fa-check'></i>",
                next: "Next <i class='fa fa-arrow-right'></i>",
                previous: "<i class='fa fa-arrow-left'></i> Previous",
                loading: "Loading ..."
            },
            loadingTemplate: '<h3><i class="fa fa-spin fa-spinner"></i> <strong>#text#</strong></h3>'
        };
        $("#mywizard").steps(settings);

        function changingStep(event, currentIndex, newIndex) {
            console.log(currentIndex + ", " + newIndex);
            var progress = '<h3><i class="fa fa-spin fa-spinner"></i> <strong>Please wait........</strong></h3>';
            if (currentIndex == 0 && newIndex == 1) {
                var step = $("#tax_step").val();
                console.log(step);
                if (step === "0") {
                    var myForm = $('#searchForm');
                    console.log(myForm);

                    var frmData = myForm.serialize();
                    console.log(frmData);
                    $("#taxDetsContent").html(progress);
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#paymentContent").html(resp);
                            listenPayModeChange();
                            resetValidation();
                        });


                    return true;
                } else {

                    return false;
                }
            }

            if (currentIndex == 1 && newIndex == 2) {
                //--- Payment screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#payForm');
                    var frmData = myForm.serialize();
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#confirmContent").html(resp);
                        });

                    return true;
                } else {
                    return false;
                }
            }
            if (currentIndex == 2 && newIndex == 3) {
                //--- Confirmation screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#confirmForm');
                    var frmData = myForm.serialize();
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#finishContent").html(resp);
                            listenpaymentStatusClick();
                        });

                    return true;
                } else {
                    return false;
                }
            }
            if (currentIndex == 3) {
                //--- Never go back the process was a success
                if ($("#twende").val() === "1") {
                    return false;
                }
            }
            if (currentIndex == 1 && newIndex == 0) {
                return false;
            }
            return true;
        }

        function stepChanged(event, currentIndex, newIndex) {


        }

        function listenPayModeChange() {
            $("#pay_mode").on("change", function () {
                var mode = $(this).val();
                console.log('Pay Mode: ' + mode);
                $("#account_no").hide();
                $("#cheque_no").hide();
                $("#sort_code").hide();
                $.alert.open('A charge of 1,000 is required !');
                if (mode === "1") {
                    $("#account_no").show();

                } else if (mode === "2") {
                    $("#account_no").show();
                    $("#cheque_no").show();
                } else if (mode === "3") {
                    $("#cheque_no").show();
                    $("#sort_code").show();
                    loadBanks();
                } else if (mode === "4") {
                    $("#cheque_no").show();
                    $("#sort_code").show();

                    loadBanks();
                }

                setCharge(mode);

            });
            $("#pay_mode").change();
        }

        function listenDomesticTaxChange() {
            $("#domestictax").on("change", function () {
                var code = $(this).val();
               console.log('Domestic Tax: ' + code);
                domestictaxcatergory(code);
            });
            $("#domestictax").change();
        }

        function listenDomesticTaxType() {
            $("#domestictaxtype").on("change", function () {
                var code = $(this).val();
               console.log('Domestic Tax Type: ' + code);
                domestictaxname(code);
            });
            $("#domestictaxtype").change();
        }

        function TransactionCodeOthers(selecteditem) {
            sel_val = selecteditem.value;
            
            console.log(sel_val);
            if (jQuery.inArray(sel_val, ['723383', '723384', '723270','723385','724210|1','722110','723340|6', '723340|7', '723340|8', '723340|9', '723340|10', '723340|11', '724810|1', '711260|0', '711260|1', '724210|0', '724110', '723380', '711180|0', '711180|1', '711240', '722510','723290','723280', '723340|0', '723320', '723340|1', '723340|2', '723340|3', '723340|4', '723340|5', '723240', '723250', '724810|0', '723330', '721320|0', '721320|1', '721320|2', '711160|0', '711160|1']) !== -1) {
                $('#decl_no').hide();
            }
            else {
                $('#decl_no').show();
            }
             
            if (jQuery.inArray(sel_val, ['723340|1', '723340|2']) !== -1) {
                $('#doc_name').show();
            }
            else {
                $('#doc_name').hide();
            }
            if (jQuery.inArray(sel_val, ['723290']) !== -1) {
                $('#product').show();
            }
            else {
                $('#product').hide();
            }
            if (jQuery.inArray(sel_val, ['723340|3', '723340|4', '723340|5', '723340|7', '723340|8', '723340|9', '723340|10', '723340|11']) !== -1) {
                 $('#doc_type').show();
            }
            else {
                 $('#doc_type').hide();
            }
            if (jQuery.inArray(sel_val, ['723340|3', '723340|4']) !== -1) {
                $('#tot_copies').show();
            }
            else {
                $('#tot_copies').hide();
            }
             if (jQuery.inArray(sel_val, ['723340|0']) !== -1) {
                 $('#civil').show();
            }
            else {
                $('#civil').hide();
            }
            if (jQuery.inArray(sel_val, ['723340|0', '723340|1', '723340|2']) !== -1) {
                 $('#cni').show();
                 $('#cni_issue').show();
            }
            else {
                 $('#cni').hide();
                 $('#cni_issue').hide();
            }
             if (jQuery.inArray(sel_val, ['723340|6']) !== -1) {
                 $('#manufacture_year').show();
                 $('#brand').show();
            }
            else {
                 $('#manufacture_year').hide();
                 $('#brand').hide();
            }
            if (jQuery.inArray(sel_val, ['723383','723384','723270','724210|0','723340|7','724110', '723340|7', '723340|8', '723340|9','723340|10', '723340|11', '723340|6', '724810|1', '724210', '723380', '722510','723290','723280', '723340|0', '723340|1', '723340|2','723340|3','723340|4','723340|5','723240','723250','724810|0','723320','723330','721320|0','721320|1','721320|2']) !== -1) {
                $('#tin_no').hide();
                 $('#driver_name').hide();
                $('#customer').show();
            } else if (jQuery.inArray(sel_val, ['724110']) !== -1) {
                $('#tin_no').hide();
                $('#driver_name').show();
                $('#customer').hide();
            }
            else {
                $('#tin_no').show();
                $('#driver_name').hide();
                $('#customer').hide();
            }
            if (jQuery.inArray(sel_val, ['724110']) !== -1) {
                $('#contravation_no').show();
            }
            else {
                $('#contravation_no').hide();
            }
            if (jQuery.inArray(sel_val, ['723270','711260|1','723340|7', '723340|7', '723340|8', '723340|9','723340|10', '723340|11', '711260', '711180|0', '711180|1', '711240', '711160|1', '723340|6', '724810|1','724110', '723380', '722510','723290','723280', '723340|0', '723340|2', '723340|1', '723340|2','723340|3','723340|4','723340|5','723240','723250','724810|0','723320','723330','721320|1','721320|2']) !== -1) {
                $('#period_no').hide();
            }
            else {
                $('#period_no').show();
            }
             if (jQuery.inArray(sel_val, ['724210|0']) !== -1) {
                $('#infraction_type').show();
            }
            else {
                $('#infraction_type').hide();
            }
            if (jQuery.inArray(sel_val, ['722110']) !== -1) {
                $('#commune_name').show();
            }
            else {
                $('#commune_name').hide();
            }
            if (jQuery.inArray(sel_val, ['721320|0']) !== -1) {
                $('#wording').show();
            }
            else {
                $('#wording').hide();
            }
            if (jQuery.inArray(sel_val, ['721320|1']) !== -1) {
                $('#licence_type').show();
            }
            else {
                $('#licence_type').hide();
            }
             if (jQuery.inArray(sel_val, ['721320|2']) !== -1) {
                $('#licences_type').show();
            }
            else {
                $('#licences_type').hide();
            }
            if (jQuery.inArray(sel_val, ['723380', '723270']) !== -1) {
                $('#service').show();
            }
            else {
                $('#service').hide();
            }
            if (jQuery.inArray(sel_val, ['723240','723250','724810|0','723340|6']) !== -1) {
                $('#car_chassis').show();
            }
            else {
                $('#car_chassis').hide();
            }

            if (jQuery.inArray(sel_val, ['723385']) !== -1) {
                $('#car_details').show();
            }
            else {
                $('#car_details').hide();
            }
            
            if (jQuery.inArray(sel_val, ['723240','723250','724810|0']) !== -1) {
                $('#car_owner').show();
                $('#vehicle_type').show();
            } else if (jQuery.inArray(sel_val, ['723385']) !== -1) {
                $('#vehicle_type').show();
                $('#car_owner').hide();
            }
            else {
                $('#car_owner').hide();
                $('#vehicle_type').hide();
            }
             if (jQuery.inArray(sel_val, ['723240','723250','724810|0','723330','724110']) !== -1) {
                 $('#car_imma').show();
            }
            else {
               $('#car_imma').hide();
            }
            if (jQuery.inArray(sel_val, ['711310']) !== -1) {
                loadtaxadjustcat(sel_val);
                $('#adjustment').show();
                $('#majoration').show();
            }
            else {
                $('#adjustment').hide();
                $('#majoration').hide();
            }
         }
        
        function setCharge(mode) {
            var url = "@Url.Action("GetPayMode")";
            $.ajax({
                type: 'get',
                url: url,
                data: { payMode: mode}
            })
                .done(function (resp) {
                    $("#chargeVal").val(resp);
                });

        }

        function listenpaymentStatusClick() {
            $("#paymentStatus").on("click", function () {
                var Code = $(this).val();
                paymentStatus(Code);
            });
            $("#paymentStatus").click();
        }

        function paymentStatus(Code) {
            var url = "@Url.Action("GetPaymentStatus")";
            $.ajax({
                type: 'get',
                url: url,
                data: { Code: Code}
            })
                .done(function (resp) {
                    $("#paymentStatusMessage").val(resp);
                });

        }

        function loadBanks() {
            $("#banks").empty();

            var url = "@Url.Action("getbanks")";
            $.getJSON(url, function (data) {
                $.each(data, function (i, item) {
                    $("#banks").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadDomesticTax() {
            $("#domestictax").empty();

            var url = "@Url.Action("getincometax")";
            $.getJSON(url, function (data) {
                $("#domestictax").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#domestictax").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })

        }

        function loadtaxadjustcat(code) {
            $("#adjust").empty();

            var url = "@Url.Action("GetTaxCatergory")";
            $.ajax({
                type: 'get',
                url: url,
                data: { mode: code }
            })
                .done(function (resp) {
                    $("#adjust").append('<option value="">-- Select --</option>');
                    $.each(resp, function (i, item) {
                        $("#adjust").append('<option value="' + item.value + '">' + item.text + '</option>');
                    });
                });

        }

        function domestictaxcatergory(code) {
            $("#domestictaxtype").empty();
            console.log(code);
            var url = "@Url.Action("GetTaxCatergory")";
            $.ajax({
                type: 'get',
                url: url,
                data: { mode: code }
            })
                .done(function (resp) {
                    $("#domestictaxtype").append('<option value="">-- Select --</option>');
                    $.each(resp, function (i, item) {
                        $("#domestictaxtype").append('<option value="' + item.value + '">' + item.text + '</option>');
                    });
                });

        }

         function domestictaxname(code) {
            $("#domestictaxname").empty();
            console.log(code);
            var url = "@Url.Action("GetTaxCatergory")";
            $.ajax({
                type: 'get',
                url: url,
                data: { mode: code }
            })
                .done(function (resp) {
                    $("#domestictaxname").append('<option value="">-- Select --</option>');
                    $.each(resp, function (i, item) {
                        $("#domestictaxname").append('<option value="' + item.value + '">' + item.text + '</option>');
                    });
                });

        }

         function listenPayModeChange() {
            $("#pay_mode").on("change", function () {
                var mode = $(this).val();
                console.log('Pay Mode: ' + mode);
                $("#account_no").hide();
                $("#cheque_no").hide();
                $("#sort_code").hide();

                if (mode === "1") {
                    $("#account_no").show();
                } else if (mode === "2") {
                    $("#account_no").show();
                    $("#cheque_no").show();
                } else if (mode === "3") {
                    $("#cheque_no").show();
                    $("#sort_code").show();
                    loadBanks();
                } else if (mode === "4") {
                    $("#cheque_no").show();
                    $("#sort_code").show();

                    loadBanks();
                }

            });
            $("#pay_mode").change();
        }

        function resetValidation() {
            $('form').removeData('validator');
            $('form').removeData('unobtrusiveValidation');
            $.validator.unobtrusive.parse('form');
        }
    </script>
}

