
@{
    ViewData["Title"] = "Custom";
}

<h2 class="header-title">Make Custom Tax Payment</h2>
<div id="mywizard">
    <h3>Search File</h3>
    <section data-mode="async" data-url="@Url.Action("SearchFile")"></section>
    <h3>Make Payment</h3>
    <section>
        <div id="paymentContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
    <h3>Confirm</h3>
    <section>
        <div id="confirmContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
    <h3>Finish</h3>
    <section>
        <div id="finishContent">
            <h3><i class="fa fa-spin fa-spinner m-r-5"></i> <strong>Please wait........</strong></h3>
        </div>
    </section>
</div>

@section css{
    <link href="~/lib/jquery.steps/demo/css/jquery.steps.css" rel="stylesheet" />
}

@section Scripts{
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="~/lib/jquery.steps/build/jquery.steps.min.js"></script>

    <script>

        var settings = {
            headerTag: "h3",
            bodyTag: "section",
            transitionEffect: "slideLeft",
            transitionEffectSpeed: 400,
            /* Events */
            onContentLoaded: function (event, currentIndex) {
                if (currentIndex == 0) {
                    $("#searchForm").validate();
                    loadCurrency();
                    loadCustomTax();
                    loadOtherTax();
                    loadTranRef();
                }
            },
            onStepChanging: function (event, currentIndex, newIndex) {
                return changingStep(event, currentIndex, newIndex);
            },
            onStepChanged: function (event, currentIndex, priorIndex) {
                stepChanged(event, currentIndex, priorIndex);
            },
            onFinishing: function (event, currentIndex) {
                return true;
            },
            onFinished: function (event, currentIndex) {
                location.reload();
            },
            labels: {
                finish: "Finish <i class='fa fa-check'></i>",
                next: "Next <i class='fa fa-arrow-right'></i>",
                previous: "<i class='fa fa-arrow-left'></i> Previous",
                loading: "Loading ..."
            },
            loadingTemplate: '<h3><i class="fa fa-spin fa-spinner"></i> <strong>#text#</strong></h3>'
        };
        $("#mywizard").steps(settings);

        function changingStep(event, currentIndex, newIndex) {
            console.log(currentIndex + ", " + newIndex);
            var progress = '<h3><i class="fa fa-spin fa-spinner"></i> <strong>Please wait........</strong></h3>';
            if (currentIndex == 0 && newIndex == 1) {
                var step = $("#tax_step").val();
                if (step === "0") {
                    var myForm = $('#searchForm');

                    if (myForm.valid()) {
                        var frmData = myForm.serialize();
                        $("#taxDetsContent").html(progress);
                        $.ajax({
                            type: myForm.attr('method'),
                            url: myForm.attr('action'),
                            data: frmData
                        })
                            .done(function (resp) {
                                $("#taxDetsContent").html(resp);
                            });
                    }
                    return false;
                } else {
                    if ($("#twende").val() === "1") {
                        //----- Post form
                        var myForm = $('#taxForm');
                        var frmData = myForm.serialize();

                        $.ajax({
                            type: myForm.attr('method'),
                            url: myForm.attr('action'),
                            data: frmData
                        })
                            .done(function (resp) {
                                $("#paymentContent").html(resp);
                                listenPayModeChange();
                                resetValidation();
                            });

                        return true;
                    } else {
                        return false;
                    }
                }
            }

            if (currentIndex == 1 && newIndex == 2) {
                //--- Payment screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#payForm');
                    var frmData = myForm.serialize();
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#confirmContent").html(resp);
                        });

                    return true;
                } else {
                    if ($("#twende").val() === "1") {
                        //----- Post form
                        var myForm = $('#payForm');
                        var frmData = myForm.serialize();
                        $.ajax({
                            type: myForm.attr('method'),
                            url: myForm.attr('action'),
                            data: frmData
                        })
                            .done(function (resp) {
                                $("#confirmContent").html(resp);
                            });
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            if (currentIndex == 2 && newIndex == 3) {
                //--- Confirmation screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#confirmForm');
                    var frmData = myForm.serialize();
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#finishContent").html(resp);
                            listenpaymentStatusClick();
                            listenobrStatClick();
                        });

                    return true;
                } else {
                    return false;
                }
            }
            if (currentIndex == 3) {
                //--- Never go back the process was a success
                if ($("#twende").val() === "1") {
                    return false;
                }
            }
          if (currentIndex == 1 && newIndex == 0) {
                return false;
            }
            return true;
        }

        function stepChanged(event, currentIndex, newIndex) {


        }

        function listenPayModeChange() {
            $("#pay_mode").on("change", function () {
                var mode = $(this).val();
                console.log('Pay Mode: ' + mode);
                $("#account_no").hide();
                $("#cheque_no").hide();
                $("#sort_code").hide();

                if (mode === "1") {
                    $("#account_no").show();
                } else if (mode === "2") {
                    $("#account_no").show();
                    $("#cheque_no").show();
                } else if (mode === "3") {
                    $("#cheque_no").show();
                    $("#sort_code").show();
                    loadBanks();
                } else if (mode === "4") {
                    $("#cheque_no").show();
                    $("#sort_code").show();

                    loadBanks();
                }

                setCharge(mode);

            });
            $("#pay_mode").change();
        }

        function setCharge(mode) {
            var url = "@Url.Action("GetPayMode")";
            $.ajax({
                type: 'get',
                url: url,
                data: { payMode: mode}
            })
                .done(function (resp) {
                    $("#chargeVal").val(resp);
                });

        }

        function listenpaymentStatusClick() {
            $("#paymentStatus").on("click", function () {
                var Code = $(this).val();
                paymentStatus(Code);
            });
            $("#paymentStatus").click();
        }

        function paymentStatus(Code) {
            var url = "@Url.Action("GetPaymentStatus")";
            $.ajax({
                type: 'get',
                url: url,
                data: { Code: Code}
            })
                .done(function (resp) {
                    $("#paymentStatusMessage").val(resp);
                });
        }

        function listenobrStatClick() {
            $("#obrStatus").on("click", function () {
                var Code = $(this).val();
                obrStatus(Code);
            });
            $("#obrStatus").click();
        }

        function obrStatus(Code) {
            var url = "@Url.Action("GetObrtatus")";
            $.ajax({
                type: 'get',
                url: url,
                data: { Code: Code}
            })
                .done(function (resp) {
                    console.log(resp.data1);
                    $("#obrStatusCode").val(resp.data4);
                    $("#obrStatusMsg").val(resp.data1);
                });
        }

        function loadBanks() {
            $("#banks").empty();

            var url = "@Url.Action("getbanks")";
            $.getJSON(url, function (data) {
                $.each(data, function (i, item) {
                    $("#banks").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadCurrency() {
            $("#currency").empty();

            var url = "@Url.Action("getcurrencies")";
            $.getJSON(url, function (data) {
                $("#currency").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#currency").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function PayTypeChange(selecteditem) {
            sel_val = selecteditem.value;

            console.log(sel_val);
            if (jQuery.inArray(sel_val, ['1']) !== -1) {
                $("#decl").show();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['2']) !== -1) {
                $("#decl").show();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['3']) !== -1) {
                $("#decl").hide();
                $("#credit").show();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['4']) !== -1) {
                $("#credit").hide();
                $("#decl").show();
                $("#other").show();
                $("#otherdet").show();
            }
            else {
                $("#decl").hide();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
        }

         function loadCustomTax() {
             $("#customtax").empty();

            var url = "@Url.Action("getcustomtax")";
            $.getJSON(url, function (data) {
                $("#customtax").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#customtax").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadOtherTax() {
             $("#othertax").empty();

            var url = "@Url.Action("getothertaxes")";
            $.getJSON(url, function (data) {
                $("#othertax").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#othertax").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadTranRef() {
            $("#tranref").empty();

            var url = "@Url.Action("gettranref")";
            $.getJSON(url, function (data) {
                $("#tranref").append('<option value="">-- Select --</option>');
                for (var i = 0; i < data.content.taxList.length; i++) {
                    var tax = data.content.taxList[i];
                    $("#tranref").append('<option value="' + tax.code + '">' + tax.label + '</option>');
                }
            })
        }

        function resetValidation() {
            $('form').removeData('validator');
            $('form').removeData('unobtrusiveValidation');
            $.validator.unobtrusive.parse('form');
        }
    </script>
    }

