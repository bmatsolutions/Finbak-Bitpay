@model DeclarationQueryData
@{
    ViewData["Title"] = "Multiple Custom";
    var queryResult2 = ViewData["queryResult2"];
    var queryResult = ViewData["queryResult"];
}
<div class="card-box">
    <div id="taxDetsContent">
        <div class="row">
            <div class="col-sm-8">
                <p class="text-muted">
                    Enter the tax declaration details in the form below and click on Proceed button
                </p>
            </div>
            @if (Model.status != 0)
            {
                <div class="col-sm-4 text-right">
                    <a href="@Url.Action("multiplePay")" class="btn btn-success float-right"> Proceed <i class="fa fa-long-arrow-right"></i></a>
                </div>
            }
        </div>
        <br />
        <div class="col-sm-5">
            <form asp-action="MultiplePayments" id="searchForm" method="post" class="form-horizontal" role="form">
                <div class="row">
                    <div class="col-md-6">

                    </div>
                    <div class="col-md-6">

                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-12">
                        <div asp-validation-summary="ModelOnly"></div>
                        <input id="tax_step" type="hidden" value="0" />
                    </div>
                </div>
                <div class="form-group">
                    <label asp-for="TaxType" class="col-md-5 control-label"></label>
                    <div class="col-md-7">
                        <select id="customtax" asp-for="TaxType" onchange="PayTypeChange(this)" class="form-control"></select>
                        <span asp-validation-for="TaxType" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group" id="other">
                    <div class="form-group">
                        <label asp-for="TranCode" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <select id="tranref" asp-for="TranCode" class="form-control"></select>
                            <span asp-validation-for="TranCode" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label asp-for="Currencies" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <select id="currency" asp-for="Currencies" class="form-control"></select>
                            <span asp-validation-for="Currencies" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label asp-for="OfficeCode" class="col-md-5 control-label"></label>
                    <div class="col-md-7">
                        <input asp-for="OfficeCode" class="form-control" />
                        <span asp-validation-for="OfficeCode" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group" id="decl">
                    <div class="form-group" id="regyear">
                        <label asp-for="RegistrationYear" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="RegistrationYear" class="form-control" />
                            <span asp-validation-for="RegistrationYear" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="regser">
                        <label asp-for="RegistrationSerial" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="RegistrationSerial" class="form-control" />
                            <span asp-validation-for="RegistrationSerial" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="regno">
                        <label asp-for="RegistrationNumber" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="RegistrationNumber" class="form-control" />
                            <span asp-validation-for="RegistrationNumber" class="text-danger"></span>
                        </div>
                    </div>
                </div>
                <div class="form-group" id="otherdet">
                    @*<div class="form-group" id="officename">
                            <label asp-for="OfficeName" class="col-md-5 control-label"></label>
                            <div class="col-md-7">
                                <input asp-for="OfficeName" class="form-control" />
                                <span asp-validation-for="OfficeName" class="text-danger"></span>
                            </div>
                        </div>*@
                    <div class="form-group" id="tranref">
                        <label asp-for="TranRef" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="TranRef" class="form-control" />
                            <span asp-validation-for="TranRef" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="compcode">
                        <label asp-for="CompCode" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="CompCode" class="form-control" />
                            <span asp-validation-for="CompCode" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="compcode">
                        <label asp-for="DeclCode" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="DeclCode" class="form-control" />
                            <span asp-validation-for="DeclCode" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="taxpayer">
                        <label asp-for="TaxPayer" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="TaxPayer" class="form-control" />
                            <span asp-validation-for="TaxPayer" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="form-group" id="amt">
                        <label asp-for="Amount" class="col-md-5 control-label"></label>
                        <div class="col-md-7">
                            <input asp-for="Amount" class="form-control" />
                            <span asp-validation-for="Amount" class="text-danger"></span>
                        </div>
                    </div>

                </div>

                <div class="form-group">
                    <div class="col-md-offset-5 col-md-7">
                        (<span class="text-danger">*</span>) Mandatory <button class="btn btn-default"><i class="fa fa-search"></i> Search</button>
                    </div>
                </div>
            </form>
        </div>

        @if (Model.status2 != 0)
        {
            @await Html.PartialAsync("_multipleTaxDets", queryResult)

        }
    </div>

    @if (Model.status != 0)
    {
        @await Html.PartialAsync("_multiplepay", queryResult2)
    }

</div>

@section css{
    <link href="~/lib/jquery.steps/demo/css/jquery.steps.css" rel="stylesheet" />
    <link href="~/css/mydatatable.min.css" rel="stylesheet" />
    <link href="~/lib/sweetalert2/sweetalert2.min.css" rel="stylesheet" />    
}
@section Scripts{
    <script src="~/js/mydatatable.min.js"></script>
    <script src="~/lib/jquery.steps/build/jquery.steps.min.js"></script>
    <script src="~/lib/sweetalert2/sweetalert2.min.js"></script>
    <script src="~/js/dialog.js"></script>
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        $(document).ready(function () {
            $('#tblData').dataTable();
            loadCustomTax();
            loadOtherTax();
            loadTranRef();
            loadCurrency();

            $('.remove-decla').click(function (e) {
                e.preventDefault();

                var url = $(this).attr('href');
                showConfirmMessage('Remove Payment', 'Are you sure you wish to remove this payment?', function () {
                    $.get(url, function (d) {location.reload()})
                })
            })
        });

        var settings = {
            headerTag: "h3",
            bodyTag: "section",
            transitionEffect: "slideLeft",
            transitionEffectSpeed: 400,
            /* Events */
            onContentLoaded: function (event, currentIndex) {

                if (currentIndex == 0) {
                    $("#searchForm").validate();

                }
            },
            onStepChanging: function (event, currentIndex, newIndex) {
                return changingStep(event, currentIndex, newIndex);
            },
            onStepChanged: function (event, currentIndex, priorIndex) {
                stepChanged(event, currentIndex, priorIndex);
            },
            onFinishing: function (event, currentIndex) {
                return true;
            },
            onFinished: function (event, currentIndex) {
                location.reload();
            },
            labels: {
                finish: "Finish <i class='fa fa-check'></i>",
                next: "Next <i class='fa fa-arrow-right'></i>",
                previous: "<i class='fa fa-arrow-left'></i> Previous",
                loading: "Loading ..."
            },
            loadingTemplate: '<h3><i class="fa fa-spin fa-spinner"></i> <strong>#text#</strong></h3>'
        };
        $("#mywizard").steps(settings);

        function changingStep(event, currentIndex, newIndex) {
            console.log(currentIndex + ", " + newIndex);
            var progress = '<h3><i class="fa fa-spin fa-spinner"></i> <strong>Please wait........</strong></h3>';
            if (currentIndex == 0 && newIndex == 1) {
                var step = $("#tax_step").val();
                if (step === "0") {
                    var myForm = $('#searchForm');
                    if (myForm.valid()) {
                        var frmData = myForm.serialize();
                        $("#taxDetsContent").html(progress);
                        $.ajax({
                            type: myForm.attr('method'),
                            url: myForm.attr('action'),
                            data: frmData
                        })
                            .done(function (resp) {
                                $("#taxDetsContent").html(resp);
                            });
                    }
                    return false;
                } else {
                    if ($("#twende").val() === "1") {
                        //----- Post form
                        var myForm = $('#taxForm');
                        var frmData = myForm.serialize();
                        $.ajax({
                            type: myForm.attr('method'),
                            url: myForm.attr('action'),
                            data: frmData
                        })
                            .done(function (resp) {
                                $("#paymentContent").html(resp);
                                listenPayModeChange();

                            });

                        return true;
                    } else {
                        return false;
                    }
                }
            }

            if (currentIndex == 1 && newIndex == 2) {
                //--- Payment screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#payForm');
                    var frmData = myForm.serialize();

                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#confirmContent").html(resp);
                        });

                    return true;
                } else {
                    return false;
                }
            }
            if (currentIndex == 2 && newIndex == 3) {
                //--- Confirmation screen
                if ($("#twende").val() === "1") {
                    //----- Post form
                    var myForm = $('#confirmForm');
                    var frmData = myForm.serialize();
                    $.ajax({
                        type: myForm.attr('method'),
                        url: myForm.attr('action'),
                        data: frmData
                    })
                        .done(function (resp) {
                            $("#finishContent").html(resp);
                            listenpaymentStatusClick();
                        });

                    return true;
                } else {
                    return false;
                }
            }
            if (currentIndex == 3) {
                //--- Never go back the process was a success
                if ($("#twende").val() === "1") {
                    return false;
                }
            }
            if (currentIndex == 1 && newIndex == 0) {
                return false;
            }
            return true;
        }

        function stepChanged(event, currentIndex, newIndex) {


        }

        function listenPayModeChange() {
            $("#pay_mode").on("change", function () {
                var mode = $(this).val();
                console.log('Pay Mode: ' + mode);
                $("#account_no").hide();
                $("#cheque_no").hide();
                $("#sort_code").hide();

                if (mode === "1") {
                    $("#account_no").show();
                } else if (mode === "2") {
                    $("#account_no").show();
                    $("#cheque_no").show();
                } else if (mode === "3") {
                    $("#cheque_no").show();
                    $("#sort_code").show();
                    loadBanks();
                } else if (mode === "4") {
                    $("#cheque_no").show();
                    $("#sort_code").show();

                    loadBanks();
                }

                setCharge(mode);

            });
            $("#pay_mode").change();
        }

        function setCharge(mode) {
            var url = "@Url.Action("GetPayMode")";
            $.ajax({
                type: 'get',
                url: url,
                data: { payMode: mode}
            })
                .done(function (resp) {
                    $("#chargeVal").val(resp);
                });

        }

        function listenpaymentStatusClick() {
            $("#paymentStatus").on("click", function () {
                var Code = $(this).val();
                paymentStatus(Code);
            });
            $("#paymentStatus").click();
        }

        function paymentStatus(Code) {
            var url = "@Url.Action("GetPaymentStatus")";
            $.ajax({
                type: 'get',
                url: url,
                data: { Code: Code}
            })
                .done(function (resp) {
                    $("#paymentStatusMessage").val(resp);
                });

        }

        function loadBanks() {
            $("#banks").empty();

            var url = "@Url.Action("getbanks")";
            $.getJSON(url, function (data) {
                $.each(data, function (i, item) {
                    $("#banks").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadCurrency() {
            $("#currency").empty();

            var url = "@Url.Action("getcurrencies")";
            $.getJSON(url, function (data) {
                $("#currency").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#currency").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

       function PayTypeChange(selecteditem) {
            sel_val = selecteditem.value;

            console.log(sel_val);
            if (jQuery.inArray(sel_val, ['1']) !== -1) {
                $("#decl").show();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['2']) !== -1) {
                $("#decl").show();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['3']) !== -1) {
                $("#decl").hide();
                $("#credit").show();
                $("#other").hide();
                $("#otherdet").hide();
            }
            else if (jQuery.inArray(sel_val, ['4']) !== -1) {
                $("#decl").show();
                $("#credit").hide();
                $("#other").show();
                $("#otherdet").show();
            }
            else {
                $("#decl").hide();
                $("#credit").hide();
                $("#other").hide();
                $("#otherdet").hide();
            }
        }

        function loadCustomTax() {
            $("#customtax").empty();

            var url = "@Url.Action("getcustomtax")";
            $.getJSON(url, function (data) {
                $("#customtax").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#customtax").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadOtherTax() {
             $("#othertax").empty();

            var url = "@Url.Action("getothertaxes")";
            $.getJSON(url, function (data) {
                $("#othertax").append('<option value="">-- Select --</option>');
                $.each(data, function (i, item) {
                    $("#othertax").append('<option value="' + item.value + '">' + item.text + '</option>');
                });

            })
        }

        function loadTranRef() {
            $("#tranref").empty();

            var url = "@Url.Action("gettranref")";
            $.getJSON(url, function (data) {
                $("#tranref").append('<option value="">-- Select --</option>');
                for (var i = 0; i < data.content.taxList.length; i++) {
                    var tax = data.content.taxList[i];
                    $("#tranref").append('<option value="' + tax.code + '">' + tax.label + '</option>');
                }
            })
        }
    </script>

}
